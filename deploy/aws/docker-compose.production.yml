# Title Protocol 本番デプロイ用 Docker Compose
#
# ローカル開発版（docker-compose.yml）との違い:
#   - MinIO, arlocal を除外（AWS S3 + Arweave/Irys を使用）
#   - TEE は Enclave 内で稼働（Docker外）
#   - Gateway は外部S3に接続
#   - PostgreSQL は永続ボリューム付き
#
# 前提:
#   - .env に本番設定が記載済み
#   - TEE + Proxy は別途 Enclave + systemd で起動
#
# 使い方:
#   docker compose -f deploy/aws/docker-compose.production.yml up -d

services:
  # PostgreSQL (インデクサ用)
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    ports:
      - "127.0.0.1:5432:5432"
    environment:
      POSTGRES_DB: title_indexer
      POSTGRES_USER: ${DB_USER:-title}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD is required}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-title}"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Gateway
  gateway:
    build:
      context: ../..
      dockerfile: docker/gateway.Dockerfile
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file:
      - ../../.env
    environment:
      # TEEはEnclave内、Proxyが localhost:4000 で中継
      TEE_ENDPOINT: "http://host.docker.internal:4000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy

  # インデクサ
  indexer:
    build:
      context: ../..
      dockerfile: docker/indexer.Dockerfile
    restart: unless-stopped
    ports:
      - "5000:5000"
    env_file:
      - ../../.env
    environment:
      DATABASE_URL: "postgres://${DB_USER:-title}:${DB_PASSWORD}@postgres:5432/title_indexer"
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres-data:
